name: Sultan

permissions:
  contents: write
  actions: write

on:
  workflow_call:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
  push:
    paths-ignore:
      - 'README.md'

jobs:
  build:
    runs-on: ubuntu-latest
    if: >
      ${{ 
        github.event_name != 'pull_request' ||
        contains(github.event.pull_request.labels.*.name, 'build')
      }}
    name: >-
      ${{ matrix.kernel.codename }}-
      ${{ matrix.variant.type }}${{ matrix.susfs && '_SUSFS' || '' }}
    strategy:
      fail-fast: false
      matrix:
        kernel:
          - codename: zuma
            repo: "android_kernel_google_zuma"
            android_version: "android14"
            kernel_version: "6.1"
            defconfig: zuma_defconfig
            local_version: "-android14-11-g66e758f7d0c0-ab13748739"
            build_date: "Tue Jul 8 09:17:32 UTC 2025"
        variant:
          - type: SukiSU
            ksu: true
            ak3_suffix: "_SukiSU"
            repo: "SukiSU-Ultra/SukiSU-Ultra"
            folder: "KernelSU"
            branch: "susfs-main"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            extra_configs: "CONFIG_KSU_MANUAL_HOOK=y CONFIG_KSU_MANUAL_SU=n CONFIG_COMPAT=y CONFIG_ZRAM_GS_WRITEBACK=y"
          - type: xxKSU
            ksu: true
            ak3_suffix: "_xxKSU"
            repo: "backslashxx/KernelSU"
            folder: "KernelSU"
            branch: "master"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            extra_configs: ""
          - type: KowSU
            ksu: true
            ak3_suffix: "_KowSU"
            repo: "KOWX712/KernelSU"
            folder: "KernelSU"
            branch: "staging"
            kernel_patches: "sultan/scope-min-hooks-v1.6.patch"
            extra_configs: ""
        susfs: [false, true]
        exclude:
          - variant:
              type: xxKSU
            susfs: true
          - variant:
              type: KowSU
            susfs: true
          - variant:
              type: SukiSU
            susfs: false

    steps:
      - name: Download and extract GCC 14.2.0 toolchain
        run: |
          echo "Downloading GCC 14.2.0..."
          wget -q https://kernel.org/pub/tools/crosstool/files/bin/x86_64/14.2.0/x86_64-gcc-14.2.0-nolibc-aarch64-linux.tar.gz -O gcc.tar.gz
          gunzip gcc.tar.gz
          tar -xf gcc.tar
          echo "GCC 14.2.0 ready"

      - name: Clone Dependencies and Set ENV
        run: |
          ANYKERNEL_BRANCH="sultan-${{ matrix.kernel.codename }}"
          SUSFS_BRANCH="gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}"

          sudo apt-get update && sudo apt-get install -y ccache
          ccache --max-size=2G
          ccache --set-config=compression=true
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheWildJames/AnyKernel3.git -b "$ANYKERNEL_BRANCH" AK3
          echo "ak3_dir=$PWD/AK3" >> $GITHUB_ENV

          git clone --depth=5 https://gitlab.com/simonpunk/susfs4ksu.git -b "$SUSFS_BRANCH" susfs
          echo "susfs_dir=$PWD/susfs" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheWildJames/kernel_patches.git james_patches
          echo "james_dir=$PWD/james_patches" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/TheSillyOk/kernel_ls_patches ok_patches
          echo "ok_dir=$PWD/ok_patches" >> $GITHUB_ENV

          git clone --depth=1 https://github.com/kerneltoast/${{ matrix.kernel.repo }} sultan
          echo "kernel_dir=$PWD/sultan" >> $GITHUB_ENV

          # === CLONE SH SCRIPTS ONCE ===
          git clone --depth=1 https://github.com/TheSillyOk/sh sh

          # === GET KSU VARIANT & VERSION ===
          KSU_VARIANT="${{ matrix.variant.type }}"
          KSU_VER="unknown"

          case "$KSU_VARIANT" in
            "SukiSU")
              KSU_VER=$(./sh/extract_ksuver.sh "https://github.com/SukiSU-Ultra/SukiSU-Ultra" "kernel/Makefile" "." "susfs-main" || echo "unknown")
              ;;
            "xxKSU")
              KSU_VER=$(./sh/extract_ksuver.sh "https://github.com/backslashxx/KernelSU" "kernel/Makefile" "." || echo "unknown")
              ;;
            "KowSU")
              KSU_VER=$(./sh/extract_ksuver.sh "https://github.com/KOWX712/KernelSU" "kernel/Makefile" "." "staging" || echo "unknown")
              ;;
          esac

          echo "KSU_VARIANT=$KSU_VARIANT" >> $GITHUB_ENV
          echo "KSU_VER=$KSU_VER" >> $GITHUB_ENV

          # === FINAL ZIP NAME ===
          DATE=$(date +"%-d.%-m.%Y")  # e.g., 5.11.2025
          ZIP_NAME="${DATE}-${{ matrix.kernel.codename }}_A16_Sultan-${KSU_VARIANT}-${KSU_VER}.zip"
          echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

      - name: Setup Kernel Configs
        run: |
          cd "${{ env.kernel_dir }}"

          # Apply kernel patches
          if [[ -n "${{ matrix.variant.kernel_patches }}" ]]; then
            for patch in ${{ matrix.variant.kernel_patches }}; do
              patch -p1 -F 3 < "${{ env.ok_dir }}/$patch" && echo "Applied: $patch"
            done
          fi

          # Base + extra configs
          configs="CONFIG_TMPFS_XATTR=y CONFIG_TMPFS_POSIX_ACL=y CONFIG_IP_NF_TARGET_TTL=y CONFIG_IP6_NF_TARGET_HL=y CONFIG_IP6_NF_MATCH_HL=y CONFIG_TCP_CONG_ADVANCED=y CONFIG_TCP_CONG_BBR=y CONFIG_NET_SCH_FQ=y CONFIG_TCP_CONG_BIC=n CONFIG_TCP_CONG_WESTWOOD=n CONFIG_TCP_CONG_HTCP=n CONFIG_DEFAULT_BBR=y CONFIG_BPF_STREAM_PARSER=y CONFIG_NETFILTER_XT_MATCH_ADDRTYPE=y CONFIG_NETFILTER_XT_SET=y CONFIG_IP_SET=y CONFIG_IP_SET_MAX=65534 CONFIG_IP_SET_BITMAP_IP=y CONFIG_IP_SET_BITMAP_IPMAC=y CONFIG_IP_SET_BITMAP_PORT=y CONFIG_IP_SET_HASH_IP=y CONFIG_IP_SET_HASH_IPMARK=y CONFIG_IP_SET_HASH_IPPORT=y CONFIG_IP_SET_HASH_IPPORTIP=y CONFIG_IP_SET_HASH_IPPORTNET=y CONFIG_IP_SET_HASH_IPMAC=y CONFIG_IP_SET_HASH_MAC=y CONFIG_IP_SET_HASH_NETPORTNET=y CONFIG_IP_SET_HASH_NET=y CONFIG_IP_SET_HASH_NETNET=y CONFIG_IP_SET_HASH_NETPORT=y CONFIG_IP_SET_HASH_NETIFACE=y CONFIG_IP_SET_LIST_SET=y CONFIG_IP6_NF_NAT=y CONFIG_IP6_NF_TARGET_MASQUERADE=y"
          configs="$configs ${{ matrix.variant.extra_configs }}"

          for config in $configs; do
            name=$(echo "$config" | cut -d'=' -f1)
            sed -i -E "s/.*($name=.*)/# \1 is not set/gi" arch/arm64/configs/${{ matrix.kernel.defconfig }}
            echo "$config" >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
          done

          sed -i 's/${LOCALVERSION+set}/set/' scripts/setlocalversion
          sed -i 's/CONFIG_LOCALVERSION="-Sultan"/CONFIG_LOCALVERSION="${{ matrix.kernel.local_version }}"/' arch/arm64/configs/${{ matrix.kernel.defconfig }}
          perl -pi -e 's/build-timestamp = \$\(or \$\(KBUILD_BUILD_TIMESTAMP\), \$\(build-timestamp-auto\)\)/build-timestamp = "${{ matrix.kernel.build_date }}"/' init/Makefile

      - name: Add KernelSU (${{ matrix.variant.type }}${{ matrix.susfs && ' + SUSFS' || '' }})
        if: matrix.variant.ksu
        run: |
          cd "${{ env.kernel_dir }}"

          echo "Adding ${{ matrix.variant.type }}..."

          curl -LSs "https://raw.githubusercontent.com/${{ matrix.variant.repo }}/${{ matrix.variant.branch }}/kernel/setup.sh" \
            | bash -s -- "${{ matrix.variant.branch }}"

          if [[ -n "${{ matrix.variant.folder }}" ]]; then
            cd "${{ matrix.variant.folder }}"
          fi

          if [[ -n "${{ matrix.variant.ksu_patches }}" ]]; then
            for p in ${{ matrix.variant.ksu_patches }}; do
              echo "Applying KSU patch: $p"
              patch -p1 < "${{ env.ok_dir }}/$p"
            done
          fi

          cd "${{ env.kernel_dir }}"

          echo "CONFIG_KSU=y" >> "arch/arm64/configs/${{ matrix.kernel.defconfig }}"

          case "${{ matrix.variant.type }}" in
            "SukiSU") echo "SukiSU Ultra with scope-min-hooks v1.6" ;;
            "xxKSU")  echo "xxKSU (backslashxx/KernelSU) integrated" ;;
            "KowSU")  echo "KowSU (KOWX712/KernelSU) integrated" ;;
          esac

      - name: Apply SUSFS Patches
        if: matrix.susfs && matrix.variant.ksu
        run: |
          echo "Applying SUSFS v1.5.12..."
          cd "${{ env.kernel_dir }}"
          cp ${{ env.susfs_dir }}/kernel_patches/50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch .
          cp ${{ env.susfs_dir }}/kernel_patches/fs/* fs/
          cp ${{ env.susfs_dir }}/kernel_patches/include/linux/* include/linux/
          patch -p1 < 50_add_susfs_in_gki-${{ matrix.kernel.android_version }}-${{ matrix.kernel.kernel_version }}.patch || true
          patch -p1 --fuzz=3 < ${{ env.james_dir }}/sultan/sys.c_fix.patch || true

          cat << EOF >> arch/arm64/configs/${{ matrix.kernel.defconfig }}
          CONFIG_KSU_SUSFS=y
          CONFIG_KSU_SUSFS_SUS_OVERLAYFS=n
          CONFIG_KSU_SUSFS_SUS_SU=n
          EOF

      - name: Cache Kernel Build
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ matrix.kernel.codename }}-${{ matrix.variant.type }}-SUSFS_${{ matrix.susfs }}-ccache-${{ github.sha }}
          restore-keys: |
            ${{ matrix.kernel.codename }}-${{ matrix.variant.type }}-SUSFS_${{ matrix.susfs }}-ccache-
            ${{ matrix.kernel.codename }}-${{ matrix.variant.type }}-

      - name: Build Kernel
        run: |
          cd "${{ env.kernel_dir }}"
          export KBUILD_BUILD_USER="build-user"
          export KBUILD_BUILD_HOST="build-host"
          make O=out CROSS_COMPILE=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux- CC=$GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc ${{ matrix.kernel.defconfig }}
          make O=out CROSS_COMPILE="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-" CC="ccache $GITHUB_WORKSPACE/gcc-14.2.0-nolibc/aarch64-linux/bin/aarch64-linux-gcc" -j$(nproc --all)

      - name: Package AnyKernel3
        run: |
          cp "${{ env.kernel_dir }}/out/arch/arm64/boot/Image.lz4" "${{ env.ak3_dir }}/Image.lz4"
          cat "${{ env.kernel_dir }}/out/google-devices/${{ matrix.kernel.codename }}/dts/"*.dtb \
              > "${{ env.ak3_dir }}/dtb"

          cd "${{ env.ak3_dir }}"
          zip -r9 "${GITHUB_WORKSPACE}/${{ env.ZIP_NAME }}" . -x "*.git*" "README.md" "placeholder"
          cd "${GITHUB_WORKSPACE}"

          sha256sum "${{ env.ZIP_NAME }}" > "${{ env.ZIP_NAME }}.sha256"
          echo "ZIP_FULLPATH=${GITHUB_WORKSPACE}/${{ env.ZIP_NAME }}" >> "$GITHUB_ENV"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: kernel-build-${{ matrix.variant.type }}${{ matrix.susfs && '-SUSFS' || '' }}
          path: |
            ${{ env.ZIP_FULLPATH }}
           
           

  release:
    needs: build
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: Set Release Info
        id: info
        run: |
          echo "date=$(date +"%d/%m/%Y")" >> $GITHUB_ENV
          git clone --depth=1 https://github.com/TheSillyOk/sh sh
          echo "sh_dir=$PWD/sh" >> $GITHUB_ENV

          SUKI_URL=$(git ls-remote https://github.com/SukiSU-Ultra/SukiSU-Ultra main | awk '{print "https://github.com/SukiSU-Ultra/SukiSU-Ultra/commit/"$1}')
          XXKSU_URL=$(git ls-remote https://github.com/backslashxx/KernelSU master | awk '{print "https://github.com/backslashxx/KernelSU/commit/"$1}')
          KOWSU_URL=$(git ls-remote https://github.com/KOWX712/KernelSU master | awk '{print "https://github.com/KOWX712/KernelSU/commit/"$1}')

          SUKI_V=$(./sh/extract_ksuver.sh "https://github.com/SukiSU-Ultra/SukiSU-Ultra" "kernel/Makefile" "." "main" || echo "unknown")
          XXKSU_V=$(./sh/get_ksuver.sh "backslashxx" "KernelSU" "master" || echo "unknown")
          KOWSU_V=$(./sh/get_ksuver.sh "KOWX712" "KernelSU" "master" || echo "unknown")

          echo "SUKI_URL=$SUKI_URL" >> $GITHUB_ENV
          echo "XXKSU_URL=$XXKSU_URL" >> $GITHUB_ENV
          echo "KOWSU_URL=$KOWSU_URL" >> $GITHUB_ENV
          echo "SUKI_V=$SUKI_V" >> $GITHUB_ENV
          echo "XXKSU_V=$XXKSU_V" >> $GITHUB_ENV
          echo "KOWSU_V=$KOWSU_V" >> $GITHUB_ENV

      - name: Generate Release Body
        id: release_body
        run: |
          cat << EOF > release_body.md
          ⚠️ **COMPATIBILITY NOTICE** ⚠️
          Please ensure compatibility by comparing release dates with official Sultan kernel releases
          
          Module:
          -> https://github.com/sidex15/ksu_module_susfs
          
          Managers:
          -> https://github.com/WildKernels/Wild_KSU
          -> https://github.com/KernelSU-Next/KernelSU-Next
          -> https://github.com/rsuntk/KernelSU
          -> https://github.com/SukiSU-Ultra/SukiSU-Ultra
          
          Features:
          [+] KowSU [${{ env.KOWSU_V }}](${{ env.KOWSU_URL }})
          [+] SukiSU [${{ env.SUKI_V }}](${{ env.SUKI_URL }})
          [+] xxKSU [${{ env.XXKSU_V }}](${{ env.XXKSU_URL }})
          [+] SUSFS v1.5.12
          EOF

      - name: Create Release Tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG=$(date +"%Y/%m/%d")
          LATEST=$(gh api repos/${{ github.repository }}/tags --jq '.[0].name' 2>/dev/null || echo "")
          if [[ "$LATEST" == "$TAG"* ]]; then
            REV=$(echo "$LATEST" | grep -o 'r[0-9]*$' | tr -d 'r')
            REV=$((REV + 1))
            TAG="${TAG}-r${REV}"
          else
            TAG="${TAG}-r1"
          fi
          gh release delete "$TAG" -y || true
          git tag "$TAG" || true
          git push origin "$TAG" || true
          echo "TAG=$TAG" >> $GITHUB_ENV

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          name: Sultan Kernel - ${{ env.date }}
          body_path: release_body.md
          files: |
            artifacts/**/*.zip
            artifacts/**/*.sha256
