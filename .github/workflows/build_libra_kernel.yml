vname: Build Libra Kernel (Clang 22.0.0git-20250928)

on:
  push:
    branches: [ personal ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      CLANG_URL: https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz
      CLANG_DIR: clang-22.0.0git
      KERNEL_DEFCONFIG: libra_defconfig
      JOBS: 8
      CCACHE_MAXSIZE: 5G

    steps:
      - name: Checkout Kernel Source
        uses: actions/checkout@v4
        with:
          repository: ximi-libra-test/android_kernel_xiaomi_libra
          ref: personal

      - name: Install Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y bc bison flex libssl-dev make ccache git zip wget python3 > /dev/null

      
      - name: Download & Extract Clang (Robust, No mv)
        run: |
          wget -q "$CLANG_URL" -O clang.tar.gz
          mkdir -p clang-22.0.0git
          tar -xzf clang.tar.gz -C clang-22.0.0git --strip-components=1
          rm -f clang.tar.gz
          echo "CLANG_PATH=$(pwd)/clang-22.0.0git" >> $GITHUB_ENV
      - name: Verify Clang
        run: |
          clang="$CLANG_PATH/bin/clang"
          echo "Clang path: $clang"
          "$clang" --version

      - name: Setup ccache
        run: |
          mkdir -p .ccache
          echo "CCACHE_DIR=$(pwd)/.ccache" >> $GITHUB_ENV
          ccache -M $CCACHE_MAXSIZE
          ccache -z

      - name: Build Kernel
        run: |
          export PATH="$CLANG_PATH/bin:$PATH"
          bash kernel_builder_clang.sh
          ccache -s

      - name: Package & Upload
        run: |
          ZIP=$(ls Kernel-*.zip | head -n1)
          FINAL="Libra-Kernel-Clang22-20250928-$(git rev-parse --short HEAD).zip"
          mv "$ZIP" "$FINAL"
          echo "FINAL_ZIP=$FINAL" >> $GITHUB_ENV

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FINAL_ZIP }}
          path: ${{ env.FINAL_ZIP }}
          retention-days: 90
