name: Build Libra Kernel (Clang 22.0.0git-20250928)

on:
  push:
    branches: [ personal ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      
      KERNEL_DEFCONFIG: libra_defconfig
      JOBS: 4
      CCACHE_MAXSIZE: 5G

    steps:
      - name: Checkout kernel source
        uses: actions/checkout@v4
        with:
          repository: ximi-libra-test/android_kernel_xiaomi_libra
          ref: personal

      - name: Install build dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y bc bison flex libssl-dev make ccache git zip wget python3 > /dev/null

      # --------------------------------------------------------------
      # 1. Download + extract Clang (inside repo, exact layout)
      # --------------------------------------------------------------
    - name: Download and setup Clang
      run: |
        mkdir -p $HOME/clang
        cd $HOME/clang
        
        # Download latest Clang from Google
        wget https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz -O clang.tar.gz
        tar -xzf clang.tar.gz
        rm clang.tar.gz
        
        echo "CLANG_PATH=$HOME/clang/bin" >> $GITHUB_ENV
        echo "$HOME/clang/bin" >> $GITHUB_PATH
          

      - name: Verify Clang
        run: |
          "$HOME/clang/bin/clang" --version

      # --------------------------------------------------------------
      # 2. ccache
      # --------------------------------------------------------------
      - name: Setup ccache
        run: |
          mkdir -p .ccache
          echo "CCACHE_DIR=$(pwd)/.ccache" >> $GITHUB_ENV
          ccache -M $CCACHE_MAXSIZE
          ccache -z

      # --------------------------------------------------------------
      # 3. Build the kernel
      # --------------------------------------------------------------
      - name: Build kernel
        run: |
          export PATH="$CLANG_PATH/bin:$PATH"
          bash kernel_builder_clang.sh
          ccache -s

      # --------------------------------------------------------------
      # 4. Package & upload
      # --------------------------------------------------------------
      - name: Package and rename zip
        run: |
          ZIP=$(ls Kernel-*.zip | head -n1)
          FINAL="Libra-Kernel-Clang22-20250928-$(git rev-parse --short HEAD).zip"
          mv "$ZIP" "$FINAL"
          echo "FINAL_ZIP=$FINAL" >> $GITHUB_ENV

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.FINAL_ZIP }}
          path: ${{ env.FINAL_ZIP }}
          retention-days: 90
