name: Build Libra Kernel with Clang 22

on:
  workflow_dispatch:

env:
  # Build configuration
  KERNEL_DIR: kernel
  CONFIG_FILE: arch/arm64/configs/libra_defconfig
  OUT_DIR: out
  
  # Compiler configuration
  USE_CCACHE: 1
  CCACHE_DIR: ${{ github.workspace }}/.ccache
  
  # GitHub-specific
  GIT_SHORT_SHA: ${{ github.event.pull_request.head.sha && github.event.pull_request.head.sha || github.sha }}

jobs:
  build-kernel:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Check Initial Disk Space
      run: |
          echo "===== Initial Total Disk Space in GB ====="
          df -BG
          
    - name: Download Apache Arrow's util_free_space.sh
      run: |
          curl -L -o util_free_space.sh https://raw.githubusercontent.com/apache/arrow/main/ci/scripts/util_free_space.sh
          chmod +x util_free_space.sh
          ./util_free_space.sh
          
    - name: Check Disk Space After Cleanup
      run: |
          echo "===== Total Disk Space After Cleanup in GB ====="
          df -BG

    - name: Set up environment
      run: |
        echo "GIT_SHORT_SHA=$(echo ${{ env.GIT_SHORT_SHA }} | cut -c1-7)" >> $GITHUB_ENV
        echo "THREADS=$(nproc)" >> $GITHUB_ENV

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          bc \
          bison \
          flex \
          libssl-dev \
          libelf-dev \
          libncurses-dev \
          zip \
          ccache \
          curl \
          git \
          wget \
          cpio \
          python3 \
          python3-pip \
          device-tree-compiler \
          kmod \
          u-boot-tools

    - name: Set up ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: libra-kernel-clang22
        max-size: 5G

    - name: Download and setup Clang 22
      run: |
        mkdir -p $HOME/clang
        cd $HOME/clang
        
        # Download Clang 22 from ZyCromerZ
        wget https://github.com/ZyCromerZ/Clang/releases/download/22.0.0git-20250928-release/Clang-22.0.0git-20250928.tar.gz -O clang.tar.gz
        tar -xzf clang.tar.gz
        rm clang.tar.gz
        
        echo "CLANG_PATH=$HOME/clang/bin" >> $GITHUB_ENV
        echo "$HOME/clang/bin" >> $GITHUB_PATH

    - name: Download ARM64 GCC toolchain
      run: |
        mkdir -p $HOME/toolchains
        cd $HOME/toolchains
        
        # Clone LineageOS ARM64 toolchain
        git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_aarch64_aarch64-linux-android-4.9 aarch64-linux-android-4.9
        
        echo "ARM64_TOOLCHAIN=$HOME/toolchains/aarch64-linux-android-4.9/bin/aarch64-linux-android-" >> $GITHUB_ENV

    - name: Download ARM32 GCC toolchain
      run: |
        cd $HOME/toolchains
        
        # Clone LineageOS ARM32 toolchain
        git clone --depth=1 https://github.com/LineageOS/android_prebuilts_gcc_linux-x86_arm_arm-linux-androideabi-4.9 arm-linux-androideabi-4.9
        
        echo "ARM32_TOOLCHAIN=$HOME/toolchains/arm-linux-androideabi-4.9/bin/arm-linux-androideabi-" >> $GITHUB_ENV

    - name: Clone Libra kernel source
      run: |
        git clone --depth=1 https://github.com/ximi-libra-test/android_kernel_xiaomi_libra -b personal ${{ env.KERNEL_DIR }}

    - name: Prepare build
      working-directory: ${{ env.KERNEL_DIR }}
      run: |
        # Remove version check scripts if they exist
        sed -i '/# Check for uncommitted changes\./,/fi/d' ./scripts/setlocalversion 2>/dev/null || true
        
        # Create output directory
        mkdir -p ${{ env.OUT_DIR }}

    - name: Make defconfig
      working-directory: ${{ env.KERNEL_DIR }}
      run: |
        make -j${{ env.THREADS }} \
          LLVM_IAS=1 \
          LLVM=1 \
          ARCH=arm64 \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}" \
          CROSS_COMPILE_ARM32="${{ env.ARM32_TOOLCHAIN }}" \
          CC="ccache clang" \
          LD=ld.lld \
          HOSTLD=ld.lld \
          O="${{ env.OUT_DIR }}" \
          libra_defconfig

    - name: Build kernel
      working-directory: ${{ env.KERNEL_DIR }}
      run: |
        make -j${{ env.THREADS }} \
          LLVM_IAS=1 \
          LLVM=1 \
          ARCH=arm64 \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          CROSS_COMPILE="${{ env.ARM64_TOOLCHAIN }}" \
          CROSS_COMPILE_ARM32="${{ env.ARM32_TOOLCHAIN }}" \
          CC="ccache clang" \
          LD=ld.lld \
          HOSTLD=ld.lld \
          O="${{ env.OUT_DIR }}"

    - name: Check build output
      run: |
        if [ ! -f "${{ env.KERNEL_DIR }}/${{ env.OUT_DIR }}/arch/arm64/boot/Image.gz-dtb" ] && \
           [ ! -f "${{ env.KERNEL_DIR }}/${{ env.OUT_DIR }}/arch/arm64/boot/Image" ]; then
          echo "Error: Kernel Image not found!"
          ls -la "${{ env.KERNEL_DIR }}/${{ env.OUT_DIR }}/arch/arm64/boot/" || true
          exit 1
        fi
        echo "Build successful!"
        ls -lh "${{ env.KERNEL_DIR }}/${{ env.OUT_DIR }}/arch/arm64/boot/"

    - name: Prepare kernel artifacts
      run: |
        mkdir -p artifacts
        cd "${{ env.KERNEL_DIR }}/${{ env.OUT_DIR }}/arch/arm64/boot"
        
        # Copy kernel image (try both possible names)
        if [ -f Image.gz-dtb ]; then
          cp Image.gz-dtb ${{ github.workspace }}/artifacts/
        elif [ -f Image ]; then
          cp Image ${{ github.workspace }}/artifacts/
        fi
        
        # Copy dtb if exists
        if [ -f *.dtb ]; then
          cp *.dtb ${{ github.workspace }}/artifacts/ 2>/dev/null || true
        fi
        
        # List what we're uploading
        ls -lh ${{ github.workspace }}/artifacts/

    - name: Upload kernel artifacts
      uses: actions/upload-artifact@v4
      with:
        name: libra-kernel-clang22-${{ env.GIT_SHORT_SHA }}
        path: artifacts/*
        if-no-files-found: error

    - name: Create build info
      run: |
        cat > artifacts/build-info.txt << EOF
        Kernel: Xiaomi Libra
        Build Date: $(date)
        Compiler: Clang 22.0.0git-20250928
        Commit: ${{ github.sha }}
        Branch: ${{ github.ref_name }}
        EOF
        
    - name: Upload build info
      uses: actions/upload-artifact@v4
      with:
        name: build-info-${{ env.GIT_SHORT_SHA }}
        path: artifacts/build-info.txt
